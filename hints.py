from typing import List, Dict, Optional
import random
from datetime import datetime, timedelta
from logger import logger

class HintSystem:
    """–°–∏—Å—Ç–µ–º–∞ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥—Å–∫–∞–∑–æ–∫ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""
    
    def __init__(self):
        # –ü–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
        self._hints = {
            'general': [
                "üí° –ó–∞–¥–∞–≤–∞–π—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –±–æ–ª–µ–µ —Ç–æ—á–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤",
                "üí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /examples —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –ø—Ä–∏–º–µ—Ä—ã —Ö–æ—Ä–æ—à–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤",
                "üí° –ù–µ –∑–∞–±—ã–≤–∞–π—Ç–µ —É–∫–∞–∑—ã–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤–∞—à–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞"
            ],
            'html': [
                "üí° –ü—Ä–∏ –≤–æ–ø—Ä–æ—Å–∞—Ö –æ HTML, –ø–æ–∫–∞–∑—ã–≤–∞–π—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –≤–∞—à–µ–π —Ä–∞–∑–º–µ—Ç–∫–∏",
                "üí° –£–∫–∞–∂–∏—Ç–µ, –∫–∞–∫–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø–æ–ª—É—á–∏—Ç—å",
                "üí° –û–ø–∏—à–∏—Ç–µ, –∫–∞–∫ —ç–ª–µ–º–µ–Ω—Ç—ã –¥–æ–ª–∂–Ω—ã –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å –¥—Ä—É–≥ —Å –¥—Ä—É–≥–æ–º",
                "üí° –ù–µ –∑–∞–±—É–¥—å—Ç–µ —É–ø–æ–º—è–Ω—É—Ç—å, –¥–ª—è –∫–∞–∫–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ —Å–æ–∑–¥–∞—ë—Ç—Å—è –≤—ë—Ä—Å—Ç–∫–∞",
                "üí° –£–∫–∞–∂–∏—Ç–µ –≤–µ—Ä—Å–∏—é HTML, –∫–æ—Ç–æ—Ä—É—é –≤—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ"
            ],
            'css': [
                "üí° –ü—Ä–∏ –≤–æ–ø—Ä–æ—Å–∞—Ö –æ —Å—Ç–∏–ª—è—Ö, —É–∫–∞–∂–∏—Ç–µ —Ç–µ–∫—É—â–∏–µ CSS –ø—Ä–∞–≤–∏–ª–∞",
                "üí° –û–ø–∏—à–∏—Ç–µ –∂–µ–ª–∞–µ–º—ã–π –≤–∏–∑—É–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç",
                "üí° –£–∫–∞–∂–∏—Ç–µ, –∫–∞–∫–∏–µ –±—Ä–∞—É–∑–µ—Ä—ã –¥–æ–ª–∂–Ω—ã –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å—Å—è",
                "üí° –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ flexbox –∏–ª–∏ grid, –ø–æ–∫–∞–∂–∏—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞",
                "üí° –ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å—é, —É–∫–∞–∂–∏—Ç–µ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ —Ç–æ—á–∫–∏"
            ],
            'layout': [
                "üí° –û–ø–∏—à–∏—Ç–µ –∂–µ–ª–∞–µ–º—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –º–∞–∫–µ—Ç–∞",
                "üí° –£–∫–∞–∂–∏—Ç–µ, –¥–æ–ª–∂–µ–Ω –ª–∏ –¥–∏–∑–∞–π–Ω –±—ã—Ç—å –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–º",
                "üí° –ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º–∏ –∫ –ø–æ–¥–¥–µ—Ä–∂–∫–µ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤",
                "üí° –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ –∂–µ–ª–∞–µ–º–æ–º –ø–æ–≤–µ–¥–µ–Ω–∏–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ —ç–∫—Ä–∞–Ω–∞"
            ],
            'inactive': [
                "üí° –î–∞–≤–Ω–æ –Ω–µ –±—ã–ª–æ –≤–æ–ø—Ä–æ—Å–æ–≤? –Ø –≥–æ—Ç–æ–≤ –ø–æ–º–æ—á—å —Å –≤—ë—Ä—Å—Ç–∫–æ–π!",
                "üí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /help —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å –≤—Å–µ –º–æ–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏",
                "üí° –ù–µ —Å—Ç–µ—Å–Ω—è–π—Ç–µ—Å—å –∑–∞–¥–∞–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã –ø–æ HTML –∏ CSS - —è –∑–¥–µ—Å—å, —á—Ç–æ–±—ã –ø–æ–º–æ—á—å"
            ]
        }
        
        # –ü—Ä–∏–º–µ—Ä—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
        self._examples = {
            'html': [
                ("‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ: '–ü–æ–º–æ–≥–∏ —Å HTML'",
                 "‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ: '–ö–∞–∫ —Å–æ–∑–¥–∞—Ç—å –∞–¥–∞–ø—Ç–∏–≤–Ω—É—é –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—É—é –ø–∞–Ω–µ–ª—å —Å –ø–æ–¥–º–µ–Ω—é? –í–æ—Ç –º–æ—è —Ç–µ–∫—É—â–∞—è —Ä–∞–∑–º–µ—Ç–∫–∞: ...'"),
                ("‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ: '–ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤—ë—Ä—Å—Ç–∫–∞'",
                 "‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ: '–ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ div —ç–ª–µ–º–µ–Ω—Ç–∞ –Ω–∞—Ä—É—à–∞–µ—Ç—Å—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–µ—Ç–∫–∏. –í–æ—Ç –∫–æ–¥: ...'"),
                ("‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ: '–°–¥–µ–ª–∞–π —Å–∞–π—Ç'",
                 "‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ: '–ö–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞—Ç—å HTML –¥–ª—è –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω–∞? –ú–æ–π —Ç–µ–∫—É—â–∏–π –∫–æ–¥: ...'")
            ],
            'css': [
                ("‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ: '–°—Ç–∏–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç'",
                 "‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ: '–ö–∞–∫ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å div –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ –∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏ —Å –ø–æ–º–æ—â—å—é flexbox? –ú–æ–π CSS: ...'"),
                ("‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ: '–ü–æ–º–æ–≥–∏ —Å CSS'",
                 "‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ: '–ö–∞–∫ —Å–æ–∑–¥–∞—Ç—å –∞–¥–∞–ø—Ç–∏–≤–Ω—É—é —Å–µ—Ç–∫—É —Ç–æ–≤–∞—Ä–æ–≤ —Å –ø–æ–º–æ—â—å—é grid, –∫–æ—Ç–æ—Ä–∞—è –º–µ–Ω—è–µ—Ç—Å—è —Å 4 –Ω–∞ 2 –∫–æ–ª–æ–Ω–∫–∏ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö?'"),
                ("‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ: '–ù–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è –≤—ë—Ä—Å—Ç–∫–∞'",
                 "‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ: '–ö–∞–∫ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤—ã–ø–∞–¥–∞—é—â–µ–µ –º–µ–Ω—é –Ω–∞ —á–∏—Å—Ç–æ–º CSS? –í–æ—Ç —á—Ç–æ —è –ø—Ä–æ–±–æ–≤–∞–ª: ...'")
            ],
            'layout': [
                ("‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ: '–ö–∞–∫ —Å–¥–µ–ª–∞—Ç—å –º–∞–∫–µ—Ç?'",
                 "‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ: '–ö–∞–∫ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –¥–≤—É—Ö–∫–æ–ª–æ–Ω–æ—á–Ω—ã–π –º–∞–∫–µ—Ç —Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º —Å–∞–π–¥–±–∞—Ä–æ–º –∏ –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º—ã–º –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º?'"),
                ("‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ: '–ù–µ –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è'",
                 "‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ: '–ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –º–µ–¥–∏–∞-–∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ —Å–∞–π—Ç–∞ –ø–æ–¥ –º–æ–±–∏–ª—å–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞? –¢–µ–∫—É—â–∏–µ –±—Ä–µ–π–∫–ø–æ–∏–Ω—Ç—ã: ...'"),
                ("‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ: '–°–¥–µ–ª–∞–π –∞–¥–∞–ø—Ç–∏–≤'",
                 "‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ: '–ö–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å flex-wrap –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–π –≥–∞–ª–µ—Ä–µ–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π?'")
            ]
        }
        
        # –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø–æ–¥—Å–∫–∞–∑–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        self._last_hint = {}
        # –°—á–µ—Ç—á–∏–∫ –ø–æ–∫–∞–∑–∞–Ω–Ω—ã—Ö –ø–æ–¥—Å–∫–∞–∑–æ–∫
        self._hint_counter = {}
        # –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É –ø–æ–¥—Å–∫–∞–∑–∫–∞–º–∏ (–≤ —Å–µ–∫—É–Ω–¥–∞—Ö)
        self._hint_interval = 300  # 5 –º–∏–Ω—É—Ç
        
        logger.info("–°–∏—Å—Ç–µ–º–∞ –ø–æ–¥—Å–∫–∞–∑–æ–∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞")
    
    def get_hint(self, user_id: int, category: str = 'general') -> Optional[str]:
        """
        –ü–æ–ª—É—á–∏—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        
        Args:
            user_id (int): ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            category (str): –ö–∞—Ç–µ–≥–æ—Ä–∏—è –ø–æ–¥—Å–∫–∞–∑–∫–∏
            
        Returns:
            Optional[str]: –ü–æ–¥—Å–∫–∞–∑–∫–∞ –∏–ª–∏ None, –µ—Å–ª–∏ —Å–ª–∏—à–∫–æ–º —Ä–∞–Ω–æ
        """
        now = datetime.now()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å–ª–∏—à–∫–æ–º –ª–∏ —Ä–∞–Ω–æ –¥–ª—è –Ω–æ–≤–æ–π –ø–æ–¥—Å–∫–∞–∑–∫–∏
        if user_id in self._last_hint:
            time_since_last = (now - self._last_hint[user_id]).total_seconds()
            if time_since_last < self._hint_interval:
                return None
        
        # –ü–æ–ª—É—á–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫–∏ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        hints = self._hints.get(category, self._hints['general'])
        
        # –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—É—é –ø–æ–¥—Å–∫–∞–∑–∫—É
        hint = random.choice(hints)
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        self._last_hint[user_id] = now
        self._hint_counter[user_id] = self._hint_counter.get(user_id, 0) + 1
        
        logger.info(f"–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø–æ–¥—Å–∫–∞–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id} (–∫–∞—Ç–µ–≥–æ—Ä–∏—è: {category})")
        return hint
    
    def get_example(self, category: str = 'html') -> str:
        """
        –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–∏–º–µ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
        
        Args:
            category (str): –ö–∞—Ç–µ–≥–æ—Ä–∏—è –ø—Ä–∏–º–µ—Ä–∞
            
        Returns:
            str: –ü—Ä–∏–º–µ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
        """
        if category not in self._examples:
            category = 'html'
            
        example = random.choice(self._examples[category])
        return f"{example[0]}\n{example[1]}"
    
    def should_show_hint(self, user_id: int, last_activity: datetime) -> bool:
        """
        –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω—É–∂–Ω–æ –ª–∏ –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        
        Args:
            user_id (int): ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            last_activity (datetime): –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
            
        Returns:
            bool: True, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É
        """
        now = datetime.now()
        
        # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω –±–æ–ª–µ–µ 10 –º–∏–Ω—É—Ç
        if (now - last_activity).total_seconds() > 600:
            # –ò –ø—Ä–æ—à–ª–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤—Ä–µ–º–µ–Ω–∏ —Å –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø–æ–¥—Å–∫–∞–∑–∫–∏
            if user_id not in self._last_hint or \
               (now - self._last_hint[user_id]).total_seconds() > self._hint_interval:
                return True
        
        return False
    
    def get_stats(self, user_id: int) -> Dict:
        """
        –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ–¥—Å–∫–∞–∑–æ–∫ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        
        Args:
            user_id (int): ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            
        Returns:
            Dict: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–¥—Å–∫–∞–∑–æ–∫
        """
        return {
            'total_hints': self._hint_counter.get(user_id, 0),
            'last_hint': self._last_hint.get(user_id),
        }
    
    def reset_stats(self, user_id: int) -> None:
        """
        –°–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ–¥—Å–∫–∞–∑–æ–∫ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        
        Args:
            user_id (int): ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        """
        if user_id in self._hint_counter:
            del self._hint_counter[user_id]
        if user_id in self._last_hint:
            del self._last_hint[user_id]
        logger.info(f"–°–±—Ä–æ—à–µ–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–¥—Å–∫–∞–∑–æ–∫ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")

# –°–æ–∑–¥–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä —Å–∏—Å—Ç–µ–º—ã –ø–æ–¥—Å–∫–∞–∑–æ–∫
hint_system = HintSystem() 